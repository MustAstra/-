**РОССИЙСКИЙ УНИВЕРСИТЕТ ДРУЖБЫ**

> **НАРОДОВ**

**Факультет физико-математических и естественных**

**наук**

**Кафедра теории вероятностей и кибербезопасности**

**Отчет лабораторной работы 16**

**Дисциплина:** Администрирование сетевых подсистем

Студент: Астахова Марина

Группа: НПИбд-02-23

***Тема:*** Базовая защита от атак типа «brute force»

***1***

***6.1. Цель работы.***

Получить навыки работы с программным средством Fail2ban для

обеспечения базовой защиты от атак типа «bruteforce».

***1***

***6.2. Выполнение работы***

**1**

**6.2.1. Защита с помощью Fail2ban**

На сервере установим Fail2ban

Запустим сервер fail2ban:

В дополнительном терминале запустим просмотр журнала событий

fail2ban:

Создаем файл с локальной конфигурацией fail2ban:

Перезапустим

Посмотрим журнал событий

В файле/etc/fail2ban/jail.d/customisation.local включим защиту HTTP:

Перезапустим:

Посмотрим журнал событий:

В файле/etc/fail2ban/jail.d/customisation.local включим защиту почты:

Перезапустим и посмотрим журнал:

**1**

**6.2.2. Проверка работы Fail2ban**

Посмотрим статус:

Посмотрим статус защиты SSH

Установим максимальное количество ошибок для SSH, равное 2:

Проверим снятие блокировки:

Опять посмотрим журнал:

Попытаемся зайти с неправильным паролем и проверить статус защиты

**1**

**6.2.3. Внесение изменений в настройки внутреннего**

**окружения виртуальных машин**

В каталоге /vagrant/provision/server создаем исполняемый файл
protect.sh:

Добавим изменения в vagrantfile

***1***

***6.3. Итог работы***

Были получены навыки работы с программным средством Fail2ban для

обеспечения базовой защиты от атак типа «bruteforce».

***1***

***6.4 Контрольные вопросы***

**1**

**. Принцип работы Fail2ban**

Fail2ban --- это система предотвращения вторжений, которая работает по

следующему принципу:

Логи приложений → Анализ по фильтрам → Обнаружение атак →

Блокировка IP → (опционально) Уведомление

**2**

**. Приоритетность файлов конфигурации**

Более приоритетными являются настройки в jail.local.

Порядок приоритета:

*1*

*2*

*3*

*4*

*. /etc/fail2ban/jail.d/\*.local*

*. /etc/fail2ban/jail.local*

*. /etc/fail2ban/jail.d/\*.conf*

*. /etc/fail2ban/jail.conf*

**3**

**. Настройка оповещения администратора**

**Способ 1: Email уведомления**

ini

\[

DEFAULT\]

destemail =
[[admin@ваш-домен.com](mailto:admin@Ð²Ð°Ñ-Ð´Ð¾Ð¼ÐµÐ½.com)]{.underline}

sender =
[[fail2ban@ваш-домен.com](mailto:fail2ban@Ð²Ð°Ñ-Ð´Ð¾Ð¼ÐµÐ½.com)]{.underline}

action = %(action_mwl)s \# mwl = ban + email с whois + лог

**Способ 2: Telegram/Slack**

bash

\#

> Создайте файл действия для Telegram

sudo tee /etc/fail2ban/action.d/telegram.conf \<\< \'EOF\'

> Definition\]

\[

actionstart =

actionstop =

actioncheck =

actionban = curl -s -X POST

> [[https://api.telegram.org/bot\<BOT_TOKEN\>/sendMessage]{.underline}\"](https://api.telegram.org/bot%3cBOT_TOKEN%3e/sendMessage)
> \\
>
> d \"chat_id=\<CHAT_ID\>&text=IP \<ip\> заблокирован в \<name\>\"

[\"](https://api.telegram.org/bot%3cBOT_TOKEN%3e/sendMessage)

\-

actionunban =

EOF

**Способ 3: Использование mailx**

ini

\[

DEFAULT\]

mta = mailx

destemail = [<admin@example.com>]{.underline}

action = %(action_mail)s

**4**

**. Настройки для веб-службы в /etc/fail2ban/jail.conf**

Ini

\#

APACHE - аутентификация

\[

apache-auth\]

enabled = false

\# по умолчанию выключено

port

= http,https

\# порты для мониторинга

filter = apache-auth

\# файл фильтра: /etc/fail2ban/filter.d/apache-

auth.conf

logpath = /var/log/apache2/\*error.log \# путь к логам

maxretry = 6 \# максимум 6 попыток

\#

\[

> APACHE - плохие боты
>
> apache-badbots\]

enabled = false

port = http,https

filter = apache-badbots

logpath = /var/log/apache2/\*access.log

maxretry = 2

bantime = 172800

\# всего 2 попытки

> \# блокировка на 48 часов (для ботов)

\#

\[

> APACHE - атаки на скрипты
>
> apache-noscript\]

enabled = false

port = http,https

filter = apache-noscript

logpath = /var/log/apache2/\*error.log

maxretry = 6

\#

\[

> APACHE - переполнение буфера
>
> apache-overflows\]

enabled = false

port = http,https

filter = apache-overflows

logpath = /var/log/apache2/\*error.log

maxretry = 2

**5**

**. Настройки для почтовой службы в /etc/fail2ban/jail.conf**

ini

> POSTFIX - основная защита
>
> postfix\]

\#

\[

enabled = false

\# по умолчанию выключено

port

= smtp,ssmtp,submission \# SMTP порты

filter = postfix

logpath = /var/log/mail.log

maxretry = 6

\# фильтр: /etc/fail2ban/filter.d/postfix.conf

\# путь к логам почты

\#

> POSTFIX - SASL аутентификация
>
> postfix-sasl\]

enabled = false

\[

port

= smtp,ssmtp,submission,imap2,imap3,imaps,pop3,pop3s

filter = postfix-sasl

logpath = /var/log/mail.log

maxretry = 6

\#

\[

> DOVECOT - IMAP/POP3 сервер
>
> dovecot\]

enabled = false

port

= pop3,pop3s,imap,imaps \# почтовые протоколы

filter = dovecot

logpath = /var/log/mail.log

maxretry = 5

bantime = 1800

\# 30 минут блокировки

\#

\[

> SENDMAIL (альтернатива Postfix)
>
> sendmail-auth\]

enabled = false

port

= smtp,ssmtp,submission

filter = sendmail-auth

logpath = /var/log/mail.log

**6**

**. Действия Fail2ban при обнаружении атак**

Основные действия:

***1***

***2***

***3***

***4***

***5***

***. Блокировка в firewall (iptables, firewalld, nftables)***

***. Отправка email***

***. Выполнение произвольной команды***

***. Отправка в Slack/Telegram***

***. Запись в syslog***

**7**

**. Получить список действующих правил**

\#

1\. Список активных тюрем

sudo fail2ban-client status

\#

2\. Подробно о конкретной тюрьме

sudo fail2ban-client status sshd

\#

> 3\. Проверить правила firewall

sudo iptables -L -n -v \| grep f2b

> или для firewalld

sudo firewall-cmd \--list-all \| grep -A10 \"fail2ban\"

\#

\#

4\. Все тюрьмы с их фильтрами

sudo fail2ban-client -d \| grep \"\\\[\" \| head --20

**8**

**. Статистика заблокированных адресов**

\#

1\. Общая статистика по всем тюрьмам

sudo fail2ban-client status

\#

2\. Статистика конкретной тюрьмы

sudo fail2ban-client status sshd \| grep -E \"(Currently banned\|Total

banned\|Banned IP list)\"

\#

3\. Логи блокировок

sudo grep \"Ban \" /var/log/fail2ban.log

sudo grep \"Unban \" /var/log/fail2ban.log

\#

4\. Статистика за период

sudo journalctl -u fail2ban \--since \"today\" \| grep -E
\"(Ban\|Unban)\"

\#

5\. Утилита fail2ban-stat

sudo fail2ban-stat

**9**

**. Как разблокировать IP-адрес**

\#

1\. Разблокировать конкретный IP в конкретной тюрьме

sudo fail2ban-client set sshd unbanip 192.168.1.100

\#

2\. Разблокировать несколько IP

sudo fail2ban-client set sshd unbanip 192.168.1.100 192.168.1.101

\#

3\. Разблокировать во всех тюрьмах

for jail in \$(sudo fail2ban-client status \| grep \"Jail list:\" \| cut
-d: -f2 \| tr \',\' \' \'); do

> sudo fail2ban-client set \$jail unbanip 192.168.1.100

done

\#

4\. Сбросить счетчик попыток (без разблокировки)

sudo fail2ban-client set sshd delip 192.168.1.100

\#

5\. Посмотреть заблокированные IP перед разблокировкой

sudo fail2ban-client status sshd \| grep \"Banned IP list\"

\#

6\. Полная перезагрузка тюрьмы (сброс всех блокировок)

sudo fail2ban-client reload sshd

\#

7\. Проверить, что IP разблокирован

sudo iptables -L -n -v \| grep 192.168.1.100
